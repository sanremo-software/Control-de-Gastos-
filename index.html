<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sanremo AR Torten-Projektor - COMPLETO</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      color: white;
      overflow: hidden;
      touch-action: none;
      height: 100vh;
      width: 100vw;
    }

    /* Container principal */
    .app {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    /* C√¢mara em tempo real */
    .camera-container {
      position: relative;
      flex: 1;
      width: 100%;
      overflow: hidden;
      background: #000;
    }

    #camera-feed {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Canvas de sobreposi√ß√£o - onde a MAGIA acontece */
    .overlay-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 5;
    }

    #drawing-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    /* Preview do texto */
    .text-preview {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(10px);
      padding: 15px 25px;
      border-radius: 50px;
      color: white;
      font-size: 24px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.2);
      z-index: 10;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      pointer-events: none;
    }

    /* Painel de controlos - SEMPRE vis√≠vel */
    .control-panel {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(0,0,0,0.4));
      padding: 25px 20px;
      z-index: 20;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .control-row {
      display: flex;
      gap: 12px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .btn {
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 15px 25px;
      border-radius: 40px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      backdrop-filter: blur(5px);
      transition: all 0.2s;
      min-width: 80px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .btn:active {
      transform: scale(0.95);
      background: rgba(255,255,255,0.3);
    }

    .btn-primary {
      background: #FFD700;
      color: black;
      border: none;
    }

    .btn-primary.active {
      background: #333;
      color: white;
    }

    .btn-large {
      padding: 18px 35px;
      font-size: 22px;
      background: #FFD700;
      color: black;
      flex: 1;
    }

    .slider-container {
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
      padding: 15px 20px;
      border-radius: 40px;
      width: 100%;
      border: 1px solid rgba(255,255,255,0.2);
      margin-bottom: 10px;
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 16px;
      color: #FFD700;
    }

    input[type=range] {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      background: linear-gradient(to right, #FFD700, #FF4500);
      border-radius: 10px;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      cursor: pointer;
      border: 2px solid #FFD700;
    }

    /* Modal de edi√ß√£o */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #1a1a1a;
      padding: 30px;
      border-radius: 40px;
      width: 90%;
      max-width: 500px;
      border: 2px solid #FFD700;
    }

    .modal h2 {
      color: #FFD700;
      margin-bottom: 25px;
      font-size: 28px;
    }

    .modal input, .modal select {
      width: 100%;
      padding: 18px;
      margin-bottom: 20px;
      border-radius: 30px;
      border: 1px solid #333;
      background: #333;
      color: white;
      font-size: 18px;
    }

    .modal label {
      display: block;
      margin-bottom: 8px;
      color: #FFD700;
      font-size: 16px;
    }

    .modal-buttons {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }

    /* Indicadores */
    .status-indicator {
      position: absolute;
      top: 100px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      padding: 12px 20px;
      border-radius: 40px;
      font-size: 16px;
      z-index: 10;
      border: 1px solid #FFD700;
      color: #FFD700;
      backdrop-filter: blur(5px);
    }

    /* Mensagem de erro */
    .error-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,0,0,0.9);
      color: white;
      padding: 30px;
      border-radius: 30px;
      text-align: center;
      z-index: 1000;
      display: none;
    }
  </style>
</head>
<body>
<div class="app">
  <!-- Mensagem de erro -->
  <div class="error-message" id="errorMessage">
    <h2>‚ùå Kamera Fehler</h2>
    <p>Bitte Kamera-Zugriff erlauben</p>
    <button class="btn" onclick="location.reload()">Neu laden</button>
  </div>

  <!-- C√¢mara -->
  <div class="camera-container">
    <video id="camera-feed" autoplay playsinline></video>
    
    <!-- Canvas de sobreposi√ß√£o -->
    <div class="overlay-canvas">
      <canvas id="drawing-canvas" width="1080" height="1920"></canvas>
    </div>

    <!-- Preview texto -->
    <div class="text-preview" id="textPreview">
      Alles Gute zum Geburtstag!
    </div>

    <!-- Status -->
    <div class="status-indicator" id="statusIndicator">
      üåô NORMAL MODUS
    </div>
  </div>

  <!-- Painel de controlos -->
  <div class="control-panel">
    <!-- Slider tamanho -->
    <div class="slider-container">
      <div class="slider-label">
        <span>üìè Textgr√∂sse</span>
        <span id="sizeValue">70</span>
      </div>
      <input type="range" id="sizeSlider" min="30" max="200" value="70">
    </div>

    <!-- Slider posi√ß√£o Y -->
    <div class="slider-container">
      <div class="slider-label">
        <span>‚¨ÜÔ∏è Position Y</span>
        <span id="yValue">0</span>
      </div>
      <input type="range" id="ySlider" min="-300" max="300" value="0">
    </div>

    <!-- Bot√µes principais -->
    <div class="control-row">
      <button class="btn" id="textBtn">‚úèÔ∏è Text</button>
      <button class="btn" id="fontBtn">üìù Schrift</button>
      <button class="btn" id="ageBtn">üéÇ Alter</button>
    </div>

    <div class="control-row">
      <button class="btn" id="colorBtn" style="background: #FFD700; color: black;">üü° Farbe</button>
      <button class="btn btn-primary" id="shadowBtn">üåô SCHATTEN</button>
      <button class="btn" id="resetBtn">‚ü≤ Reset</button>
    </div>

    <div class="control-row">
      <button class="btn btn-large" id="captureBtn">üì∏ FOTO MACHEN</button>
    </div>
  </div>

  <!-- Modal Texto -->
  <div class="modal" id="textModal">
    <div class="modal-content">
      <h2>‚úèÔ∏è Text eingeben</h2>
      <input type="text" id="textInput" value="Alles Gute zum Geburtstag!">
      <div class="modal-buttons">
        <button class="btn" style="flex:1;" onclick="closeModal('textModal')">Abbrechen</button>
        <button class="btn btn-primary" style="flex:1;" onclick="saveText()">Speichern</button>
      </div>
    </div>
  </div>

  <!-- Modal Schriftart -->
  <div class="modal" id="fontModal">
    <div class="modal-content">
      <h2>üìù Schriftart</h2>
      <select id="fontSelect">
        <option value="Arial">Arial (einfach)</option>
        <option value="'Great Vibes'">Great Vibes (elegant)</option>
        <option value="'Pacifico'">Pacifico (verspielt)</option>
        <option value="'Playfair Display'">Playfair Display (klassisch)</option>
        <option value="'Dancing Script'">Dancing Script (schwungvoll)</option>
        <option value="Georgia">Georgia (serif)</option>
        <option value="'Comic Sans MS'">Comic Sans (kindlich)</option>
      </select>
      <div class="modal-buttons">
        <button class="btn" style="flex:1;" onclick="closeModal('fontModal')">Abbrechen</button>
        <button class="btn btn-primary" style="flex:1;" onclick="saveFont()">Speichern</button>
      </div>
    </div>
  </div>

  <!-- Modal Alter -->
  <div class="modal" id="ageModal">
    <div class="modal-content">
      <h2>üéÇ Alter</h2>
      <select id="ageSelect">
        <option value="0">Kein Alter</option>
        <option value="1">1 Jahr</option>
        <option value="2">2 Jahre</option>
        <option value="3">3 Jahre</option>
        <option value="4">4 Jahre</option>
        <option value="5">5 Jahre</option>
        <option value="6">6 Jahre</option>
        <option value="7">7 Jahre</option>
        <option value="8">8 Jahre</option>
        <option value="9">9 Jahre</option>
        <option value="10">10 Jahre</option>
        <option value="18">18 Jahre</option>
        <option value="30">30 Jahre</option>
        <option value="40">40 Jahre</option>
        <option value="50">50 Jahre</option>
        <option value="60">60 Jahre</option>
      </select>
      
      <label style="margin-top: 20px;">Gr√∂sse: <span id="ageSizeValue">120</span></label>
      <input type="range" id="ageSize" min="50" max="250" value="120">
      
      <label style="margin-top: 15px;">Y Position: <span id="ageYValue">-80</span></label>
      <input type="range" id="ageY" min="-300" max="300" value="-80">

      <div class="modal-buttons">
        <button class="btn" style="flex:1;" onclick="closeModal('ageModal')">Abbrechen</button>
        <button class="btn btn-primary" style="flex:1;" onclick="saveAge()">Speichern</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Elementos DOM
  const video = document.getElementById('camera-feed');
  const canvas = document.getElementById('drawing-canvas');
  const ctx = canvas.getContext('2d');
  const textPreview = document.getElementById('textPreview');
  const errorMessage = document.getElementById('errorMessage');
  
  // ===== ESTADO DA APLICA√á√ÉO =====
  const state = {
    shadowMode: false,
    text: "Alles Gute zum Geburtstag!",
    font: "'Great Vibes'",
    textSize: 70,
    textY: 0,
    age: 0,
    ageSize: 120,
    ageY: -80,
    color: '#FFD700', // Dourado
    colorIndex: 0
  };
  
  // Cores dispon√≠veis
  const colors = ['#FFD700', '#FF0000', '#00FF00', '#00FFFF', '#FF00FF', '#FFFFFF'];
  
  // ===== INICIALIZAR C√ÇMARA =====
  async function initCamera() {
    try {
      // Verificar se o navegador suporta c√¢mara
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw new Error('Keine Kamera-Unterst√ºtzung');
      }
      
      const constraints = {
        video: {
          facingMode: 'environment', // C√¢mara traseira
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        },
        audio: false
      };
      
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      
      // Aguardar v√≠deo carregar
      await new Promise((resolve) => {
        video.onloadedmetadata = () => {
          video.play();
          resolve();
        };
      });
      
      // Ajustar canvas ao tamanho do v√≠deo
      canvas.width = video.videoWidth || 1080;
      canvas.height = video.videoHeight || 1920;
      
      // Iniciar desenho
      drawLoop();
      
    } catch (err) {
      console.error('Kamera Fehler:', err);
      errorMessage.style.display = 'block';
    }
  }
  
  // ===== LOOP DE DESENHO =====
  function drawLoop() {
    drawOverlay();
    requestAnimationFrame(drawLoop);
  }
  
  function drawOverlay() {
    // Limpar canvas (transparente)
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Configurar estilo
    ctx.lineWidth = 8;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    // CORES - MODO SOMBRA
    if (state.shadowMode) {
      ctx.strokeStyle = state.color;
      ctx.fillStyle = state.color;
      ctx.shadowColor = state.color;
      ctx.shadowBlur = 30;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;
    } else {
      ctx.strokeStyle = '#FFFFFF';
      ctx.fillStyle = '#FFFFFF';
      ctx.shadowColor = 'rgba(0,0,0,0.5)';
      ctx.shadowBlur = 10;
    }
    
    // Calcular centro (com propor√ß√£o do ecr√£)
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = Math.min(canvas.width, canvas.height) * 0.35;
    
    // Desenhar c√≠rculo da torta
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.stroke();
    
    // Segundo c√≠rculo (interior)
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius * 0.95, 0, Math.PI * 2);
    ctx.strokeStyle = state.shadowMode ? state.color : '#CCCCCC';
    ctx.stroke();
    
    // Linhas de centro (t√©nues)
    ctx.globalAlpha = 0.3;
    ctx.beginPath();
    ctx.moveTo(centerX, centerY - radius * 1.2);
    ctx.lineTo(centerX, centerY + radius * 1.2);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(centerX - radius * 1.2, centerY);
    ctx.lineTo(centerX + radius * 1.2, centerY);
    ctx.stroke();
    ctx.globalAlpha = 1;
    
    // Desenhar texto principal
    ctx.font = `${state.textSize}px ${state.font}`;
    ctx.fillStyle = state.shadowMode ? state.color : '#FFFFFF';
    ctx.fillText(state.text, centerX, centerY + state.textY);
    
    // Desenhar idade
    if (state.age > 0) {
      ctx.font = `bold ${state.ageSize}px Arial`;
      ctx.globalAlpha = 0.4;
      ctx.fillStyle = state.shadowMode ? state.color : '#FFFFFF';
      ctx.fillText(state.age.toString(), centerX, centerY + state.ageY);
      ctx.globalAlpha = 1;
    }
    
    // Atualizar preview
    textPreview.style.color = state.shadowMode ? state.color : '#FFFFFF';
    textPreview.style.fontFamily = state.font;
    textPreview.textContent = state.text;
  }
  
  // ===== MODO SOMBRA =====
  function toggleShadowMode() {
    state.shadowMode = !state.shadowMode;
    
    const btn = document.getElementById('shadowBtn');
    const indicator = document.getElementById('statusIndicator');
    
    if (state.shadowMode) {
      btn.innerHTML = '‚òÄÔ∏è NORMAL';
      btn.classList.add('active');
      indicator.innerHTML = '‚ú® SCHATTEN MODUS';
      indicator.style.color = state.color;
      requestWakeLock();
    } else {
      btn.innerHTML = 'üåô SCHATTEN';
      btn.classList.remove('active');
      indicator.innerHTML = 'üåô NORMAL MODUS';
      indicator.style.color = '#FFD700';
      releaseWakeLock();
    }
  }
  
  // ===== WAKE LOCK =====
  let wakeLock = null;
  
  async function requestWakeLock() {
    try {
      if ('wakeLock' in navigator) {
        wakeLock = await navigator.wakeLock.request('screen');
      }
    } catch (err) {
      console.log('Wake Lock nicht unterst√ºtzt');
    }
  }
  
  async function releaseWakeLock() {
    try {
      if (wakeLock) {
        await wakeLock.release();
        wakeLock = null;
      }
    } catch (err) {}
  }
  
  // ===== CONTROLOS =====
  
  // Sliders
  document.getElementById('sizeSlider').addEventListener('input', (e) => {
    state.textSize = parseInt(e.target.value);
    document.getElementById('sizeValue').innerText = state.textSize;
  });
  
  document.getElementById('ySlider').addEventListener('input', (e) => {
    state.textY = parseInt(e.target.value);
    document.getElementById('yValue').innerText = state.textY;
  });
  
  // Modal functions
  window.closeModal = (modalId) => {
    document.getElementById(modalId).classList.remove('active');
  };
  
  // Text Modal
  document.getElementById('textBtn').addEventListener('click', () => {
    document.getElementById('textInput').value = state.text;
    document.getElementById('textModal').classList.add('active');
  });
  
  window.saveText = () => {
    state.text = document.getElementById('textInput').value;
    closeModal('textModal');
  };
  
  // Font Modal
  document.getElementById('fontBtn').addEventListener('click', () => {
    document.getElementById('fontSelect').value = state.font;
    document.getElementById('fontModal').classList.add('active');
  });
  
  window.saveFont = () => {
    state.font = document.getElementById('fontSelect').value;
    closeModal('fontModal');
  };
  
  // Age Modal
  document.getElementById('ageBtn').addEventListener('click', () => {
    document.getElementById('ageSelect').value = state.age;
    document.getElementById('ageSize').value = state.ageSize;
    document.getElementById('ageY').value = state.ageY;
    document.getElementById('ageSizeValue').innerText = state.ageSize;
    document.getElementById('ageYValue').innerText = state.ageY;
    document.getElementById('ageModal').classList.add('active');
  });
  
  window.saveAge = () => {
    state.age = parseInt(document.getElementById('ageSelect').value);
    state.ageSize = parseInt(document.getElementById('ageSize').value);
    state.ageY = parseInt(document.getElementById('ageY').value);
    closeModal('ageModal');
  };
  
  // Age sliders update
  document.getElementById('ageSize').addEventListener('input', (e) => {
    document.getElementById('ageSizeValue').innerText = e.target.value;
  });
  
  document.getElementById('ageY').addEventListener('input', (e) => {
    document.getElementById('ageYValue').innerText = e.target.value;
  });
  
  // Color
  document.getElementById('colorBtn').addEventListener('click', () => {
    state.colorIndex = (state.colorIndex + 1) % colors.length;
    state.color = colors[state.colorIndex];
    document.getElementById('colorBtn').style.background = state.color;
  });
  
  // Shadow button
  document.getElementById('shadowBtn').addEventListener('click', toggleShadowMode);
  
  // Reset
  document.getElementById('resetBtn').addEventListener('click', () => {
    state.text = "Alles Gute zum Geburtstag!";
    state.font = "'Great Vibes'";
    state.textSize = 70;
    state.textY = 0;
    state.age = 0;
    state.ageSize = 120;
    state.ageY = -80;
    
    document.getElementById('sizeSlider').value = 70;
    document.getElementById('sizeValue').innerText = '70';
    document.getElementById('ySlider').value = 0;
    document.getElementById('yValue').innerText = '0';
    document.getElementById('textInput').value = state.text;
  });
  
  // Capture photo
  document.getElementById('captureBtn').addEventListener('click', () => {
    // Criar canvas para foto
    const photoCanvas = document.createElement('canvas');
    photoCanvas.width = video.videoWidth;
    photoCanvas.height = video.videoHeight;
    const photoCtx = photoCanvas.getContext('2d');
    
    // Desenhar v√≠deo
    photoCtx.drawImage(video, 0, 0, photoCanvas.width, photoCanvas.height);
    
    // Desenhar overlay
    photoCtx.drawImage(canvas, 0, 0, photoCanvas.width, photoCanvas.height);
    
    // Download
    const link = document.createElement('a');
    link.download = `torte-${new Date().getTime()}.png`;
    link.href = photoCanvas.toDataURL('image/png');
    link.click();
  });
  
  // Iniciar
  initCamera();
</script>
</body>
</html>
