<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <title>Sanremo Torten-Schablone (Schatten-Modus)</title>

  <!-- Klassische Schriften f√ºr Torten -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Pacifico&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f6f6;
      --panel:#ffffff;
      --text:#111;
      --muted:#666;
      --radius:14px;
      --shadowBg:#fff;
      --shadowText:#000;
    }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    header{
      position:sticky; top:0; z-index:10;
      background:var(--panel); border-bottom:1px solid #e6e6e6;
      padding:12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    header h1{ margin:0; font-size:16px; font-weight:800; }
    .right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    button, select, input{ font:inherit; }
    .btn{ border:1px solid #ddd; background:#fff; border-radius:12px; padding:8px 10px; cursor:pointer; }
    .btn.primary{ background:#111; border-color:#111; color:#fff; }
    .badge{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #ddd; background:#fff; }
    .wrap{ max-width: 1100px; margin:0 auto; padding:12px; display:grid; gap:12px; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media(min-width: 980px){ .grid{ grid-template-columns: 420px 1fr; } }
    .card{ background:var(--panel); border:1px solid #e6e6e6; border-radius:var(--radius); padding:12px; }
    .card h2{ margin:0 0 10px 0; font-size:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .field{ display:flex; flex-direction:column; gap:4px; min-width:150px; flex:1; }
    label{ font-size:12px; color:var(--muted); }
    input, select{ border:1px solid #ddd; border-radius:12px; padding:10px; background:#fff; outline:none; }
    input[type="range"]{ padding:0; height:36px; }
    .hint{ font-size:12px; color:var(--muted); line-height:1.35; }
    .sep{ border:none; border-top:1px solid #eee; margin:12px 0; }

    .stageWrap{
      position:relative;
      background:#fff;
      border:1px solid #e6e6e6;
      border-radius: var(--radius);
      overflow:hidden;
      aspect-ratio: 1 / 1;
      max-height: 78vh;
    }
    .stage{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:var(--panel);
      touch-action: none; /* for drawing */
    }
    .stage.shadow{ background:var(--shadowBg); }
    svg{ width:100%; height:100%; display:block; }

    .footerbar{
      position:fixed; left:0; right:0; bottom:0;
      background:rgba(255,255,255,0.92);
      border-top:1px solid #e6e6e6;
      padding:10px 12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      backdrop-filter: blur(8px);
      z-index:20;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; }

    /* Fullscreen stage */
    body.fullscreenStage header,
    body.fullscreenStage .grid .card{ display:none; }
    body.fullscreenStage .stageWrap{
      position:fixed; inset:0;
      border:none; border-radius:0;
      max-height:none;
      z-index:999;
    }
    body.fullscreenStage .footerbar{ z-index:1000; }
  </style>
</head>
<body>
<header>
  <h1>üéÇ Sanremo ‚Äì Torten-Schablone (rund)</h1>
  <div class="right">
    <span class="badge" id="statusBadge">Normal</span>
    <button class="btn" id="btnFullscreen">Vollbild</button>
    <button class="btn primary" id="btnShadow">Schatten-Modus</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- Controls -->
    <div class="card">
      <h2>1) Gr√∂√üe (immer rund) & Kalibrierung</h2>
      <div class="row">
        <div class="field">
          <label>Torten-Durchmesser</label>
          <select id="diameterCm">
            <option value="18">18 cm</option>
            <option value="20" selected>20 cm</option>
            <option value="24">24 cm</option>
          </select>
        </div>
        <div class="field">
          <label>Kalibrierung (Bankkarte = 85,6 mm)</label>
          <input type="range" id="pxPerMm" min="2" max="10" step="0.01" />
          <div class="hint">Lege eine EC/Bankkarte auf den Bildschirm und stelle die Breite exakt ein.</div>
        </div>
      </div>

      <hr class="sep">

      <h2>2) Kunden-Text (Schrift w√§hlen)</h2>
      <div class="row">
        <div class="field" style="flex:2; min-width:240px;">
          <label>Text (Kunde)</label>
          <input type="text" id="customerText" value="Alles Gute zum Geburtstag!" />
        </div>
        <div class="field">
          <label>Schriftart</label>
          <select id="fontChoice">
            <option value="classic">Klassisch (Serif)</option>
            <option value="elegant">Elegant (Playfair Display)</option>
            <option value="scriptClassic" selected>Schreibschrift (Great Vibes)</option>
            <option value="scriptModern">Schreibschrift (Pacifico)</option>
            <option value="simple">Einfach (Arial)</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field">
          <label>Text-Gr√∂√üe (%)</label>
          <input type="range" id="textScale" min="40" max="160" step="1" />
        </div>
        <div class="field">
          <label>Position X</label>
          <input type="range" id="textX" min="-220" max="220" step="1" />
        </div>
        <div class="field">
          <label>Position Y</label>
          <input type="range" id="textY" min="-220" max="220" step="1" />
        </div>
      </div>

      <hr class="sep">

      <h2>3) Alter (2‚Äì12) optional</h2>
      <div class="row">
        <div class="field">
          <label>Alter</label>
          <select id="age">
            <option value="0">Kein Alter</option>
          </select>
        </div>
        <div class="field">
          <label>Alter-Gr√∂√üe (%)</label>
          <input type="range" id="ageScale" min="40" max="220" step="1" />
        </div>
        <div class="field">
          <label>Alter Position Y</label>
          <input type="range" id="ageY" min="-260" max="260" step="1" />
        </div>
      </div>

      <hr class="sep">

      <h2>4) Kinder-Motive (skalierbar)</h2>
      <div class="row">
        <div class="field" style="flex:2; min-width:240px;">
          <label>Motiv ausw√§hlen</label>
          <select id="motif">
            <option value="none">Kein Motiv</option>
            <option value="heroDog">Hero-Hund (inspiriert)</option>
            <option value="superMask">Superheld-Maske (inspiriert)</option>
            <option value="unicorn">Einhorn</option>
            <option value="dino">Dino</option>
            <option value="racecar">Rennwagen</option>
            <option value="football">Fu√üball</option>
            <option value="rainbow">Regenbogen</option>
            <option value="crown">Krone</option>
            <option value="paw">Pfote</option>
            <option value="star">Stern</option>
            <option value="heart">Herz</option>
            <option value="teddy">Teddy</option>
            <option value="controller">Gaming-Controller</option>
          </select>
        </div>
        <div class="field">
          <label>Motiv Rotation (¬∞)</label>
          <input type="range" id="motifRot" min="-180" max="180" step="1" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field">
          <label>Motiv-Gr√∂√üe (%)</label>
          <input type="range" id="motifScale" min="40" max="220" step="1" />
        </div>
        <div class="field">
          <label>Motiv X</label>
          <input type="range" id="motifX" min="-260" max="260" step="1" />
        </div>
        <div class="field">
          <label>Motiv Y</label>
          <input type="range" id="motifY" min="-260" max="260" step="1" />
        </div>
      </div>

      <hr class="sep">

      <h2>5) Freihand (selbst zeichnen)</h2>
      <div class="row">
        <div class="field">
          <label>Modus</label>
          <select id="drawMode">
            <option value="off" selected>Aus</option>
            <option value="on">Freihand EIN</option>
          </select>
        </div>
        <div class="field">
          <label>Linienst√§rke</label>
          <input type="range" id="drawWidth" min="2" max="14" step="1" />
        </div>
        <div class="field">
          <label>Zeichnung-Gr√∂√üe (%)</label>
          <input type="range" id="drawScale" min="40" max="220" step="1" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field">
          <label>Zeichnung X</label>
          <input type="range" id="drawX" min="-260" max="260" step="1" />
        </div>
        <div class="field">
          <label>Zeichnung Y</label>
          <input type="range" id="drawY" min="-260" max="260" step="1" />
        </div>
        <div class="field">
          <label>Zeichnung Rotation (¬∞)</label>
          <input type="range" id="drawRot" min="-180" max="180" step="1" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" id="btnUndo">‚Ü©Ô∏è Undo</button>
        <button class="btn" id="btnClear">üßΩ L√∂schen</button>
      </div>

      <hr class="sep">

      <h2>6) Extras</h2>
      <div class="row">
        <button class="btn" id="btnRotate">‚Üª B√ºhne drehen 90¬∞</button>
        <button class="btn" id="btnFlipX">‚áÑ Spiegeln</button>
        <button class="btn" id="btnReset">Reset</button>
      </div>

      <div class="hint" style="margin-top:10px;">
        Tipp: Schatten-Modus + Helligkeit Maximum + Raum leicht abdunkeln. Dann Handy √ºber die Torte halten und mit Schokolade nachziehen.
      </div>
    </div>

    <!-- Stage -->
    <div class="stageWrap">
      <div class="stage" id="stage">
        <svg id="svg" viewBox="0 0 1000 1000" aria-label="Torten-Schablone">
          <!-- Kreis (rund) -->
          <circle id="circleOuter" cx="500" cy="500" r="420" fill="none" stroke="#111" stroke-width="2" opacity="0.35"></circle>
          <circle id="circleInner" cx="500" cy="500" r="405" fill="none" stroke="#111" stroke-width="1.5" opacity="0.18"></circle>

          <!-- sehr leichtes Kreuz (Hilfslinien) -->
          <g id="grid" opacity="0.06" stroke="#111" stroke-width="1">
            <line x1="500" y1="70" x2="500" y2="930" />
            <line x1="70" y1="500" x2="930" y2="500" />
          </g>

          <!-- Alter -->
          <g id="ageGroup" transform="translate(500 500)">
            <text id="ageText" x="0" y="0" text-anchor="middle" dominant-baseline="middle"
                  fill="#111" opacity="0.18" font-size="220" font-weight="800"> </text>
          </g>

          <!-- Kunden-Text -->
          <g id="textGroup" transform="translate(500 500)">
            <text id="custLabel" x="0" y="0" text-anchor="middle" dominant-baseline="middle"
                  fill="#111" opacity="0.95" font-size="70"> </text>
          </g>

          <!-- Motiv -->
          <g id="motifGroup" transform="translate(500 500)" opacity="0.95" fill="none" stroke="#111" stroke-linecap="round" stroke-linejoin="round">
            <!-- motif paths inserted here -->
          </g>

          <!-- Freihand -->
          <g id="drawGroup" transform="translate(500 500)" fill="none" stroke="#111" stroke-linecap="round" stroke-linejoin="round"></g>
        </svg>
      </div>
    </div>

  </div>
</div>

<div class="footerbar">
  <div class="hint" style="margin:0;">
    ‚úÖ Schatten-Modus h√§lt das Display an. Falls es trotzdem ausgeht: Android ‚ÄûBildschirm-Timeout‚Äú l√§nger stellen.
    <span id="drawHint"></span>
  </div>
  <div class="mono" id="scaleInfo"></div>
</div>

<script>
  const $ = (id)=>document.getElementById(id);

  // ---------- State ----------
  const state = {
    diameterCm: 20,
    pxPerMm: 4.2,

    customerText: "Alles Gute zum Geburtstag!",
    fontChoice: "scriptClassic",
    textScale: 100,
    textX: 0,
    textY: 0,

    age: 0,
    ageScale: 120,
    ageY: 0,

    motif: "none",
    motifScale: 120,
    motifX: 0,
    motifY: -40,
    motifRot: 0,

    drawMode: "off",
    drawWidth: 6,
    drawScale: 120,
    drawX: 0,
    drawY: 60,
    drawRot: 0,

    stageRot: 0,
    stageFlipX: false,
    shadowMode: false,
    wakeLock: null,

    // drawing data
    paths: [],     // array of {d, w}
    current: null
  };

  const KEY = "sanremo_torte_shadow_v3";

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return;
      const obj = JSON.parse(raw);
      // keep paths safe
      Object.assign(state, obj);
      if(!Array.isArray(state.paths)) state.paths = [];
    }catch(e){}
  }
  function save(){
    try{
      localStorage.setItem(KEY, JSON.stringify({
        ...state,
        wakeLock: null, current: null
      }));
    }catch(e){}
  }

  // ---------- Wake Lock ----------
  async function requestWakeLock(){
    try{
      if('wakeLock' in navigator){
        state.wakeLock = await navigator.wakeLock.request('screen');
      }
    }catch(e){}
  }
  async function releaseWakeLock(){
    try{
      if(state.wakeLock){
        await state.wakeLock.release();
        state.wakeLock = null;
      }
    }catch(e){}
  }

  // ---------- Fonts ----------
  function fontFamily(choice){
    switch(choice){
      case "classic": return 'Georgia, "Times New Roman", Times, serif';
      case "elegant": return '"Playfair Display", Georgia, serif';
      case "scriptClassic": return '"Great Vibes", cursive';
      case "scriptModern": return '"Pacifico", cursive';
      default: return 'Arial, Helvetica, sans-serif';
    }
  }

  // ---------- Motifs (generic outlines) ----------
  // All motifs are simple line drawings in a ~400x400 box centered at 0,0
  const motifs = {
    none: () => [],
    heroDog: () => ([
      // head circle
      pathCircle(0,-40,150),
      // ears
      pathArc(-85,-175,55,200,340),
      pathArc(85,-175,55,200,340),
      // eyes
      pathCircle(-45,-70,12),
      pathCircle(45,-70,12),
      // nose
      "M 0 -30 C -18 -35 -25 -10 0 -2 C 25 -10 18 -35 0 -30",
      // mouth
      "M -35 10 C -10 40 10 40 35 10",
      // badge
      "M 0 120 L 45 165 L 0 210 L -45 165 Z",
      "M -18 165 L 0 147 L 18 165 L 0 183 Z"
    ]),
    superMask: () => ([
      // mask outline
      "M -170 -20 C -130 -150 -30 -180 0 -180 C 30 -180 130 -150 170 -20 C 140 40 80 70 0 70 C -80 70 -140 40 -170 -20 Z",
      // eyes
      "M -110 -30 C -80 -80 -40 -80 -10 -30 C -40 -10 -80 -10 -110 -30 Z",
      "M 110 -30 C 80 -80 40 -80 10 -30 C 40 -10 80 -10 110 -30 Z",
      // web-ish lines (generic)
      "M 0 -180 L 0 70",
      "M -110 -120 L 0 -70 L 110 -120",
      "M -150 -40 L 0 -10 L 150 -40"
    ]),
    unicorn: () => ([
      // head
      "M -130 40 C -140 -40 -90 -140 0 -160 C 90 -140 140 -40 130 40 C 120 120 60 160 0 160 C -60 160 -120 120 -130 40 Z",
      // horn
      "M 0 -240 L 40 -160 L 0 -175 L -40 -160 Z",
      "M -18 -210 L 18 -190",
      "M -22 -190 L 22 -170",
      // ear
      "M 95 -120 C 140 -140 150 -80 115 -60",
      // mane lines
      "M -95 -120 C -140 -70 -120 10 -70 40",
      "M -70 -140 C -110 -90 -80 -10 -40 20",
      // eyes
      pathCircle(-45,-30,10),
      pathCircle(45,-30,10),
      // nose
      "M -10 70 C 0 80 10 80 20 70"
    ]),
    dino: () => ([
      // body
      "M -170 60 C -150 -80 -60 -160 60 -130 C 150 -100 170 -20 150 50 C 140 95 110 115 70 125 C 30 135 -10 130 -40 110 C -70 90 -110 95 -140 85 C -165 78 -178 75 -170 60 Z",
      // spikes
      "M -120 -40 L -105 -80 L -90 -45",
      "M -80 -70 L -65 -110 L -50 -75",
      "M -40 -90 L -25 -130 L -10 -95",
      // eye
      pathCircle(70,-55,12),
      // smile
      "M 40 -20 C 70 10 100 10 130 -5",
      // legs
      "M -40 110 L -55 160 L -20 160 L -10 120",
      "M 60 120 L 55 165 L 90 165 L 95 125",
      // tail
      "M -170 60 C -240 70 -260 20 -210 0"
    ]),
    racecar: () => ([
      // car body
      "M -190 40 C -160 -30 -90 -70 -10 -70 C 60 -70 120 -40 160 10 C 180 35 190 60 190 90 C 110 100 30 105 0 105 C -50 105 -130 95 -190 90 Z",
      // cockpit
      "M -40 -70 C -20 -120 60 -120 90 -70",
      // wheels
      pathCircle(-120,95,38),
      pathCircle(120,95,38),
      pathCircle(-120,95,16),
      pathCircle(120,95,16),
      // spoiler
      "M 150 10 L 210 10 L 210 40 L 160 40",
      // stripe
      "M -10 -70 L -10 105"
    ]),
    football: () => ([
      pathCircle(0,0,170),
      // pentagon-ish center
      "M 0 -55 L 50 -20 L 30 40 L -30 40 L -50 -20 Z",
      // seams
      "M 0 -55 L 0 -170",
      "M 50 -20 L 150 -90",
      "M 30 40 L 120 140",
      "M -30 40 L -120 140",
      "M -50 -20 L -150 -90"
    ]),
    rainbow: () => ([
      // arcs
      pathArc(0,70,220,200,340),
      pathArc(0,70,190,200,340),
      pathArc(0,70,160,200,340),
      // clouds
      "M -200 120 C -220 90 -170 70 -150 90 C -140 60 -90 60 -85 90 C -60 65 -20 85 -35 120 Z",
      "M 200 120 C 220 90 170 70 150 90 C 140 60 90 60 85 90 C 60 65 20 85 35 120 Z"
    ]),
    crown: () => ([
      "M -170 120 L -120 -40 L -40 40 L 0 -80 L 40 40 L 120 -40 L 170 120 Z",
      "M -170 120 L 170 120",
      pathCircle(-120,-40,10),
      pathCircle(0,-80,10),
      pathCircle(120,-40,10)
    ]),
    paw: () => ([
      // pads
      pathCircle(0,40,70),
      pathCircle(-85,-60,25),
      pathCircle(-25,-95,22),
      pathCircle(25,-95,22),
      pathCircle(85,-60,25)
    ]),
    star: () => ([
      "M 0 -180 L 42 -55 L 170 -55 L 65 20 L 105 150 L 0 75 L -105 150 L -65 20 L -170 -55 L -42 -55 Z"
    ]),
    heart: () => ([
      "M 0 140 C -220 -10 -120 -180 0 -80 C 120 -180 220 -10 0 140 Z"
    ]),
    teddy: () => ([
      // head
      pathCircle(0,-20,150),
      // ears
      pathCircle(-110,-150,55),
      pathCircle(110,-150,55),
      // eyes
      pathCircle(-50,-40,12),
      pathCircle(50,-40,12),
      // nose
      "M 0 0 C -18 -10 -28 15 0 25 C 28 15 18 -10 0 0 Z",
      // mouth
      "M 0 25 C 0 55 -40 60 -55 40",
      "M 0 25 C 0 55 40 60 55 40"
    ]),
    controller: () => ([
      "M -190 10 C -170 -90 -60 -120 0 -90 C 60 -120 170 -90 190 10 C 210 95 140 140 90 120 C 50 105 40 70 0 70 C -40 70 -50 105 -90 120 C -140 140 -210 95 -190 10 Z",
      // dpad
      "M -90 0 L -60 0 L -60 -30 L -30 -30 L -30 0 L 0 0 L 0 30 L -30 30 L -30 60 L -60 60 L -60 30 L -90 30 Z",
      // buttons
      pathCircle(95,0,14),
      pathCircle(125,-25,14),
      pathCircle(125,25,14),
      pathCircle(155,0,14)
    ])
  };

  function pathCircle(cx,cy,r){
    return M ${cx+r} ${cy} A ${r} ${r} 0 1 0 ${cx-r} ${cy} A ${r} ${r} 0 1 0 ${cx+r} ${cy};
  }
  function pathArc(cx,cy,r,a0,a1){
    // degrees to radians
    const rad = (d)=>d*Math.PI/180;
    const x0 = cx + r*Math.cos(rad(a0));
    const y0 = cy + r*Math.sin(rad(a0));
    const x1 = cx + r*Math.cos(rad(a1));
    const y1 = cy + r*Math.sin(rad(a1));
    const large = (a1-a0) % 360 > 180 ? 1 : 0;
    return M ${x0} ${y0} A ${r} ${r} 0 ${large} 1 ${x1} ${y1};
  }

  // ---------- Rendering helpers ----------
  function setStrokeColor(color){
    $("circleOuter").setAttribute("stroke", color);
    $("circleInner").setAttribute("stroke", color);
    $("grid").setAttribute("stroke", color);

    $("custLabel").setAttribute("fill", color);
    $("ageText").setAttribute("fill", color);

    // motif & draw are stroke-based
    $("motifGroup").setAttribute("stroke", color);
    $("drawGroup").setAttribute("stroke", color);
  }

  function applyGroupTransform(g, x, y, scalePct, rotDeg){
    const s = (scalePct/100).toFixed(4);
    g.setAttribute("transform", translate(${500 + x} ${500 + y}) rotate(${rotDeg}) scale(${s}));
  }

  function renderScale(){
    // Physical scaling of circle to match selected cm (via px/mm calibration)
    const desiredMm = state.diameterCm * 10;
    const desiredPx = desiredMm * state.pxPerMm;

    const wrap = document.querySelector(".stageWrap");
    const rect = wrap.getBoundingClientRect();
    const availablePx = Math.min(rect.width, rect.height);

    const baseDiameter = 840; // circle diameter in viewBox units
    const currentCirclePx = (baseDiameter/1000) * availablePx;
    const factor = desiredPx / currentCirclePx;

    const svg = $("svg");
    svg.style.transformOrigin = "50% 50%";
    svg.style.transform = scale(${factor});

    $("scaleInfo").textContent = √ò ${state.diameterCm} cm | Kalibrierung: ${state.pxPerMm.toFixed(2)} px/mm;
  }

  function render(){
    const shadow = state.shadowMode;
    const color = shadow ? "#000" : "#111";
    setStrokeColor(color);

    // customer text
    const t = $("custLabel");
    t.textContent = state.customerText || "";
    t.style.fontFamily = fontFamily(state.fontChoice);
    t.setAttribute("opacity", shadow ? "0.95" : "0.9");
    applyGroupTransform($("textGroup"), state.textX, state.textY, state.textScale, 0);

    // age
    const a = $("ageText");
    a.textContent = state.age && Number(state.age) > 0 ? String(state.age) : "";
    a.setAttribute("opacity", shadow ? "0.14" : "0.16"); // subtle shadow behind
    applyGroupTransform($("ageGroup"), 0, state.ageY, state.ageScale, 0);

    // motif
    const mg = $("motifGroup");
    mg.innerHTML = "";
    mg.setAttribute("stroke-width", shadow ? "10" : "9");
    mg.setAttribute("opacity", state.motif === "none" ? "0" : (shadow ? "0.95" : "0.9"));

    const paths = motifs[state.motif] ? motifs[state.motif]() : [];
    for(const d of paths){
      const p = document.createElementNS("http://www.w3.org/2000/svg","path");
      p.setAttribute("d", d);
      mg.appendChild(p);
    }
    applyGroupTransform(mg, state.motifX, state.motifY, state.motifScale, state.motifRot);

    // drawing
    renderDrawing();

    // stage rotation/flip
    const stage = $("stage");
    const flip = state.stageFlipX ? -1 : 1;
    stage.style.transformOrigin = "50% 50%";
    stage.style.transform = scaleX(${flip}) rotate(${state.stageRot}deg);

    renderScale();
    updateDrawHint();
  }

  function renderDrawing(){
    const dg = $("drawGroup");
    dg.innerHTML = "";

    applyGroupTransform(dg, state.drawX, state.drawY, state.drawScale, state.drawRot);

    for(const item of state.paths){
      const p = document.createElementNS("http://www.w3.org/2000/svg","path");
      p.setAttribute("d", item.d);
      p.setAttribute("stroke-width", item.w);
      p.setAttribute("opacity", state.shadowMode ? "0.95" : "0.9");
      dg.appendChild(p);
    }
    // current
    if(state.current){
      const p = document.createElementNS("http://www.w3.org/2000/svg","path");
      p.setAttribute("d", state.current.d);
      p.setAttribute("stroke-width", state.current.w);
      p.setAttribute("opacity", state.shadowMode ? "0.95" : "0.9");
      dg.appendChild(p);
    }
  }

  function updateDrawHint(){
    const on = state.drawMode === "on";
    $("drawHint").textContent = on ? " | ‚úçÔ∏è Freihand: Zeichne direkt im Kreis." : "";
  }

  // ---------- Drawing (pointer -> SVG coords) ----------
  function clientToSvgPoint(clientX, clientY){
    const svg = $("svg");
    const pt = svg.createSVGPoint();
    pt.x = clientX; pt.y = clientY;
    const ctm = svg.getScreenCTM();
    if(!ctm) return {x:0,y:0};
    const inv = ctm.inverse();
    const sp = pt.matrixTransform(inv);
    return {x: sp.x, y: sp.y};
  }

  function startStroke(x,y){
    // store in local coordinates relative to drawGroup transform center (500,500).
    // We'll draw in absolute SVG coords and let drawGroup transform handle scaling/position (it wraps paths).
    // So we store points as if drawGroup is identity; to do that, we convert to drawGroup local:
    // easiest: subtract 500,500 and apply inverse of drawGroup transform? too heavy.
    // Practical approach: draw inside drawGroup at origin by converting absolute -> group local using inverse matrix.
    const dg = $("drawGroup");
    const pt = $("svg").createSVGPoint();
    pt.x = x; pt.y = y;
    const m = dg.getCTM();
    if(!m) return;
    const inv = m.inverse();
    const lp = pt.matrixTransform(inv);
    state.current = { d: M ${lp.x.toFixed(2)} ${lp.y.toFixed(2)}, w: state.drawWidth };
  }

  function extendStroke(x,y){
    const dg = $("drawGroup");
    const pt = $("svg").createSVGPoint();
    pt.x = x; pt.y = y;
    const m = dg.getCTM();
    if(!m || !state.current) return;
    const inv = m.inverse();
    const lp = pt.matrixTransform(inv);
    state.current.d += ` L ${lp.x.toFixed(2)} ${lp.y.toFixed(2)}`;
  }

  function endStroke(){
    if(state.current){
      state.paths.push(state.current);
      state.current = null;
      save();
    }
  }

  // ---------- Shadow mode / fullscreen ----------
  async function toggleShadowMode(){
    state.shadowMode = !state.shadowMode;
    save();

    $("stage").classList.toggle("shadow", state.shadowMode);
    $("statusBadge").textContent = state.shadowMode ? "Schatten-Modus" : "Normal";
    $("btnShadow").textContent = state.shadowMode ? "Normal-Modus" : "Schatten-Modus";

    if(state.shadowMode) await requestWakeLock();
    else await releaseWakeLock();

    render();
  }

  function toggleFullscreen(){
    document.body.classList.toggle("fullscreenStage");
    $("btnFullscreen").textContent = document.body.classList.contains("fullscreenStage") ? "Zur√ºck" : "Vollbild";
    setTimeout(()=>renderScale(), 50);
  }

  // ---------- Init UI ----------
  function fillAges(){
    const sel = $("age");
    for(let i=2;i<=12;i++){
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = String(i);
      sel.appendChild(opt);
    }
  }

  function initUI(){
    fillAges();

    // set defaults
    $("diameterCm").value = String(state.diameterCm);
    $("pxPerMm").value = String(state.pxPerMm);

    $("customerText").value = state.customerText;
    $("fontChoice").value = state.fontChoice;
    $("textScale").value = String(state.textScale);
    $("textX").value = String(state.textX);
    $("textY").value = String(state.textY);

    $("age").value = String(state.age);
    $("ageScale").value = String(state.ageScale);
    $("ageY").value = String(state.ageY);

    $("motif").value = state.motif;
    $("motifScale").value = String(state.motifScale);
    $("motifX").value = String(state.motifX);
    $("motifY").value = String(state.motifY);
    $("motifRot").value = String(state.motifRot);

    $("drawMode").value = state.drawMode;
    $("drawWidth").value = String(state.drawWidth);
    $("drawScale").value = String(state.drawScale);
    $("drawX").value = String(state.drawX);
    $("drawY").value = String(state.drawY);
    $("drawRot").value = String(state.drawRot);

    // events
    $("diameterCm").addEventListener("change",(e)=>{ state.diameterCm=Number(e.target.value); save(); render(); });
    $("pxPerMm").addEventListener("input",(e)=>{ state.pxPerMm=Number(e.target.value); save(); renderScale(); });

    $("customerText").addEventListener("input",(e)=>{ state.customerText=e.target.value; save(); render(); });
    $("fontChoice").addEventListener("change",(e)=>{ state.fontChoice=e.target.value; save(); render(); });
    $("textScale").addEventListener("input",(e)=>{ state.textScale=Number(e.target.value); save(); render(); });
    $("textX").addEventListener("input",(e)=>{ state.textX=Number(e.target.value); save(); render(); });
    $("textY").addEventListener("input",(e)=>{ state.textY=Number(e.target.value); save(); render(); });

    $("age").addEventListener("change",(e)=>{ state.age=Number(e.target.value); save(); render(); });
    $("ageScale").addEventListener("input",(e)=>{ state.ageScale=Number(e.target.value); save(); render(); });
    $("ageY").addEventListener("input",(e)=>{ state.ageY=Number(e.target.value); save(); render(); });

    $("motif").addEventListener("change",(e)=>{ state.motif=e.target.value; save(); render(); });
    $("motifScale").addEventListener("input",(e)=>{ state.motifScale=Number(e.target.value); save(); render(); });
    $("motifX").addEventListener("input",(e)=>{ state.motifX=Number(e.target.value); save(); render(); });
    $("motifY").addEventListener("input",(e)=>{ state.motifY=Number(e.target.value); save(); render(); });
    $("motifRot").addEventListener("input",(e)=>{ state.motifRot=Number(e.target.value); save(); render(); });

    $("drawMode").addEventListener("change",(e)=>{ state.drawMode=e.target.value; save(); updateDrawHint(); });
    $("drawWidth").addEventListener("input",(e)=>{ state.drawWidth=Number(e.target.value); save(); });
    $("drawScale").addEventListener("input",(e)=>{ state.drawScale=Number(e.target.value); save(); render(); });
    $("drawX").addEventListener("input",(e)=>{ state.drawX=Number(e.target.value); save(); render(); });
    $("drawY").addEventListener("input",(e)=>{ state.drawY=Number(e.target.value); save(); render(); });
    $("drawRot").addEventListener("input",(e)=>{ state.drawRot=Number(e.target.value); save(); render(); });

    $("btnShadow").addEventListener("click", toggleShadowMode);
    $("btnFullscreen").addEventListener("click", toggleFullscreen);

    $("btnUndo").addEventListener("click", ()=>{
      state.paths.pop();
      save(); render();
    });
    $("btnClear").addEventListener("click", ()=>{
      state.paths = [];
      state.current = null;
      save(); render();
    });

    $("btnRotate").addEventListener("click", ()=>{
      state.stageRot = (state.stageRot + 90) % 360;
      save(); render();
    });
    $("btnFlipX").addEventListener("click", ()=>{
      state.stageFlipX = !state.stageFlipX;
      save(); render();
    });
    $("btnReset").addEventListener("click", ()=>{
      // reset transforms but keep calibration
      state.textScale=100; state.textX=0; state.textY=0;
      state.age=0; state.ageScale=120; state.ageY=0;
      state.motif="none"; state.motifScale=120; state.motifX=0; state.motifY=-40; state.motifRot=0;
      state.drawMode="off"; state.drawWidth=6; state.drawScale=120; state.drawX=0; state.drawY=60; state.drawRot=0;
      state.stageRot=0; state.stageFlipX=false;
      state.paths=[]; state.current=null;

      // push to UI
      $("textScale").value=String(state.textScale);
      $("textX").value=String(state.textX);
      $("textY").value=String(state.textY);

      $("age").value=String(state.age);
      $("ageScale").value=String(state.ageScale);
      $("ageY").value=String(state.ageY);

      $("motif").value=state.motif;
      $("motifScale").value=String(state.motifScale);
      $("motifX").value=String(state.motifX);
      $("motifY").value=String(state.motifY);
      $("motifRot").value=String(state.motifRot);

      $("drawMode").value=state.drawMode;
      $("drawWidth").value=String(state.drawWidth);
      $("drawScale").value=String(state.drawScale);
      $("drawX").value=String(state.drawX);
      $("drawY").value=String(state.drawY);
      $("drawRot").value=String(state.drawRot);

      save(); render();
    });

    // Drawing events on stage
    const stage = $("stage");
    let drawing = false;

    stage.addEventListener("pointerdown", (e)=>{
      if(state.drawMode !== "on") return;
      drawing = true;
      stage.setPointerCapture(e.pointerId);
      const p = clientToSvgPoint(e.clientX, e.clientY);
      startStroke(p.x, p.y);
      renderDrawing();
    });

    stage.addEventListener("pointermove", (e)=>{
      if(!drawing || state.drawMode !== "on") return;
      const p = clientToSvgPoint(e.clientX, e.clientY);
      extendStroke(p.x, p.y);
      renderDrawing();
    });

    stage.addEventListener("pointerup", ()=>{
      if(!drawing) return;
      drawing = false;
      endStroke();
      renderDrawing();
    });

    stage.addEventListener("pointercancel", ()=>{
      if(!drawing) return;
      drawing = false;
      endStroke();
      renderDrawing();
    });

    // reacquire wake lock if needed
    document.addEventListener('visibilitychange', async ()=>{
      if(state.shadowMode && document.visibilityState === 'visible'){
        await requestWakeLock();
      }
    });
  }

  // ---------- Boot ----------
  load();
  initUI();
  $("statusBadge").textContent = state.shadowMode ? "Schatten-Modus" : "Normal";
  $("btnShadow").textContent = state.shadowMode ? "Normal-Modus" : "Schatten-Modus";
  $("stage").classList.toggle("shadow", state.shadowMode);
  render();
</script>
</body>
</html>
