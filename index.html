<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sanremo AR Torten-Projektor</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: #000;
      color: white;
      overflow: hidden;
      touch-action: none;
    }

    /* Container principal */
    .app {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* C√¢mara + Overlay */
    .camera-container {
      position: relative;
      flex: 1;
      width: 100%;
      overflow: hidden;
      background: #000;
    }

    #camera-feed {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1); /* Espelho para parecer natural */
    }

    /* Overlay do desenho */
    .drawing-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    canvas {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scaleX(-1); /* Compensa o espelho da c√¢mara */
      width: min(90vh, 90vw);
      height: min(90vh, 90vw);
      max-width: 100%;
      max-height: 100%;
      pointer-events: none;
    }

    /* Controlos flutuantes */
    .controls-panel {
      position: absolute;
      bottom: 30px;
      left: 0;
      right: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      padding: 20px;
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      pointer-events: none;
      z-index: 10;
    }

    .control-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
      pointer-events: auto;
    }

    .btn {
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 15px 25px;
      border-radius: 50px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 60px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .btn-primary {
      background: #ffaa00;
      color: black;
      border: none;
    }

    .btn-primary.active {
      background: #333;
      color: white;
    }

    .btn-large {
      padding: 18px 40px;
      font-size: 22px;
    }

    .slider-container {
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 30px;
      width: 90%;
      max-width: 500px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 16px;
    }

    input[type=range] {
      width: 100%;
      height: 10px;
      -webkit-appearance: none;
      background: linear-gradient(to right, #ffaa00, #ff5500);
      border-radius: 10px;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 30px;
      height: 30px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      cursor: pointer;
    }

    .text-preview {
      position: absolute;
      top: 30px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 24px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      pointer-events: none;
      background: rgba(0,0,0,0.3);
      padding: 15px;
      backdrop-filter: blur(5px);
      margin: 0 20px;
      border-radius: 50px;
      border: 1px solid rgba(255,255,255,0.2);
      z-index: 5;
    }

    /* Modal de texto */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #1a1a1a;
      padding: 30px;
      border-radius: 30px;
      width: 90%;
      max-width: 500px;
      border: 1px solid #ffaa00;
    }

    .modal h2 {
      color: #ffaa00;
      margin-bottom: 20px;
    }

    .modal input, .modal select {
      width: 100%;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 15px;
      border: 1px solid #333;
      background: #333;
      color: white;
      font-size: 18px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
    }

    .hidden {
      display: none;
    }

    .brightness-indicator {
      position: absolute;
      top: 100px;
      right: 20px;
      background: rgba(0,0,0,0.5);
      padding: 10px;
      border-radius: 30px;
      font-size: 14px;
      z-index: 5;
    }
  </style>
</head>
<body>
<div class="app">
  <!-- C√¢mara -->
  <div class="camera-container">
    <video id="camera-feed" autoplay playsinline></video>
    
    <!-- Overlay com o desenho -->
    <div class="drawing-overlay">
      <canvas id="drawing-canvas" width="1000" height="1000"></canvas>
    </div>

    <!-- Pr√©-visualiza√ß√£o do texto -->
    <div class="text-preview" id="textPreview">
      Alles Gute zum Geburtstag!
    </div>

    <!-- Indicador de brilho -->
    <div class="brightness-indicator" id="brightnessIndicator">
      üåû Helligkeit: <span id="brightnessValue">100%</span>
    </div>
  </div>

  <!-- Controlos -->
  <div class="controls-panel">
    <div class="slider-container">
      <div class="slider-label">
        <span>üîÜ Helligkeit</span>
        <span id="brightnessSliderValue">100%</span>
      </div>
      <input type="range" id="brightness" min="0" max="200" value="100" step="1">
    </div>

    <div class="control-row">
      <button class="btn" id="textBtn">‚úèÔ∏è Text</button>
      <button class="btn" id="ageBtn">üéÇ Alter</button>
      <button class="btn" id="colorBtn" style="background: #ffaa00;">üü° Farbe</button>
    </div>

    <div class="control-row">
      <button class="btn" id="sizeDownBtn">‚àí</button>
      <button class="btn btn-primary" id="shadowBtn">üåô SCHATTEN</button>
      <button class="btn" id="sizeUpBtn">+</button>
    </div>

    <div class="control-row">
      <button class="btn btn-large" id="captureBtn">üì∏ Foto machen</button>
    </div>
  </div>

  <!-- Modal de texto -->
  <div class="modal" id="textModal">
    <div class="modal-content">
      <h2>‚úèÔ∏è Text bearbeiten</h2>
      <input type="text" id="modalText" value="Alles Gute zum Geburtstag!" placeholder="Dein Text...">
      
      <select id="modalFont">
        <option value="Arial">Arial</option>
        <option value="'Great Vibes'">Great Vibes (Schreibschrift)</option>
        <option value="'Pacifico'">Pacifico</option>
        <option value="'Playfair Display'">Playfair Display</option>
        <option value="Georgia">Georgia</option>
        <option value="'Dancing Script'">Dancing Script</option>
      </select>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div>
          <label>Gr√∂sse: <span id="modalSizeValue">70</span></label>
          <input type="range" id="modalSize" min="30" max="200" value="70">
        </div>
        <div>
          <label>Y Position: <span id="modalYValue">0</span></label>
          <input type="range" id="modalY" min="-300" max="300" value="0">
        </div>
      </div>

      <div class="modal-buttons">
        <button class="btn" style="flex:1;" onclick="closeTextModal()">Abbrechen</button>
        <button class="btn btn-primary" style="flex:1;" onclick="applyTextModal()">Anwenden</button>
      </div>
    </div>
  </div>

  <!-- Modal de idade -->
  <div class="modal" id="ageModal">
    <div class="modal-content">
      <h2>üéÇ Alter</h2>
      
      <select id="modalAge">
        <option value="0">Kein Alter</option>
        <option value="1">1 Jahr</option>
        <option value="2">2 Jahre</option>
        <option value="3">3 Jahre</option>
        <option value="4">4 Jahre</option>
        <option value="5">5 Jahre</option>
        <option value="6">6 Jahre</option>
        <option value="7">7 Jahre</option>
        <option value="8">8 Jahre</option>
        <option value="9">9 Jahre</option>
        <option value="10">10 Jahre</option>
        <option value="18">18 Jahre</option>
        <option value="30">30 Jahre</option>
        <option value="40">40 Jahre</option>
        <option value="50">50 Jahre</option>
        <option value="60">60 Jahre</option>
      </select>

      <div style="margin: 15px 0;">
        <label>Gr√∂sse: <span id="modalAgeSizeValue">150</span></label>
        <input type="range" id="modalAgeSize" min="50" max="300" value="150">
      </div>

      <div style="margin: 15px 0;">
        <label>Y Position: <span id="modalAgeYValue">-50</span></label>
        <input type="range" id="modalAgeY" min="-300" max="300" value="-50">
      </div>

      <div class="modal-buttons">
        <button class="btn" style="flex:1;" onclick="closeAgeModal()">Abbrechen</button>
        <button class="btn btn-primary" style="flex:1;" onclick="applyAgeModal()">Anwenden</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Elementos
  const video = document.getElementById('camera-feed');
  const canvas = document.getElementById('drawing-canvas');
  const ctx = canvas.getContext('2d');
  const textPreview = document.getElementById('textPreview');
  
  // Estado
  let shadowMode = false;
  let currentText = "Alles Gute zum Geburtstag!";
  let currentFont = "'Great Vibes'";
  let currentTextSize = 70;
  let currentTextY = 0;
  let currentAge = 0;
  let currentAgeSize = 150;
  let currentAgeY = -50;
  let currentColor = '#ffaa00'; // Cor padr√£o
  let currentBrightness = 100;
  
  // ===== INICIAR C√ÇMARA =====
  async function initCamera() {
    try {
      const constraints = {
        video: {
          facingMode: 'environment', // C√¢mara traseira
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        }
      };
      
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      
      // Aguardar v√≠deo carregar
      video.onloadedmetadata = () => {
        video.play();
        drawOverlay();
      };
    } catch (err) {
      console.error('Erro c√¢mara:', err);
      alert('Kein Kamerazugriff! Bitte erlauben Sie den Zugriff auf die Kamera.');
    }
  }
  
  // ===== DESENHAR OVERLAY =====
  function drawOverlay() {
    ctx.clearRect(0, 0, 1000, 1000);
    
    // Fundo transparente
    ctx.clearRect(0, 0, 1000, 1000);
    
    // Configurar cores baseado no modo
    if (shadowMode) {
      ctx.strokeStyle = currentColor;
      ctx.fillStyle = currentColor;
      ctx.shadowColor = 'rgba(255,255,255,0.5)';
      ctx.shadowBlur = 10;
    } else {
      ctx.strokeStyle = '#ffffff';
      ctx.fillStyle = '#ffffff';
      ctx.shadowColor = 'rgba(0,0,0,0.3)';
      ctx.shadowBlur = 5;
    }
    
    ctx.lineWidth = 8;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;
    
    // Desenhar c√≠rculo da torta
    ctx.beginPath();
    ctx.arc(500, 500, 400, 0, Math.PI * 2);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.arc(500, 500, 380, 0, Math.PI * 2);
    ctx.strokeStyle = shadowMode ? currentColor : '#cccccc';
    ctx.stroke();
    
    // Linhas de centro (fracas)
    ctx.globalAlpha = 0.3;
    ctx.beginPath();
    ctx.moveTo(500, 100);
    ctx.lineTo(500, 900);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(100, 500);
    ctx.lineTo(900, 500);
    ctx.stroke();
    ctx.globalAlpha = 1;
    
    // Sombras para texto
    ctx.shadowBlur = shadowMode ? 20 : 5;
    
    // Desenhar texto
    ctx.font = `${currentTextSize}px ${currentFont}`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = shadowMode ? currentColor : '#ffffff';
    ctx.fillText(currentText, 500, 500 + currentTextY);
    
    // Desenhar idade
    if (currentAge > 0) {
      ctx.font = `bold ${currentAgeSize}px Arial`;
      ctx.globalAlpha = 0.4;
      ctx.fillStyle = shadowMode ? currentColor : '#ffffff';
      ctx.fillText(currentAge.toString(), 500, 500 + currentAgeY);
      ctx.globalAlpha = 1;
    }
    
    // Atualizar preview
    textPreview.style.color = shadowMode ? currentColor : '#ffffff';
    textPreview.style.fontFamily = currentFont;
    textPreview.style.fontSize = '24px';
    textPreview.textContent = currentText;
    
    requestAnimationFrame(drawOverlay);
  }
  
  // ===== MODO SOMBRA =====
  function toggleShadowMode() {
    shadowMode = !shadowMode;
    
    const btn = document.getElementById('shadowBtn');
    if (shadowMode) {
      btn.innerHTML = '‚òÄÔ∏è NORMAL';
      btn.classList.add('active');
      
      // Wake Lock
      requestWakeLock();
    } else {
      btn.innerHTML = 'üåô SCHATTEN';
      btn.classList.remove('active');
      
      // Release Wake Lock
      releaseWakeLock();
    }
  }
  
  // Wake Lock
  let wakeLock = null;
  
  async function requestWakeLock() {
    try {
      if ('wakeLock' in navigator) {
        wakeLock = await navigator.wakeLock.request('screen');
      }
    } catch (err) {
      console.log('Wake Lock error:', err);
    }
  }
  
  async function releaseWakeLock() {
    try {
      if (wakeLock) {
        await wakeLock.release();
        wakeLock = null;
      }
    } catch (err) {
      console.log('Release error:', err);
    }
  }
  
  // ===== CONTROLOS =====
  
  // Brilho
  document.getElementById('brightness').addEventListener('input', (e) => {
    currentBrightness = e.target.value;
    document.getElementById('brightnessSliderValue').innerText = currentBrightness + '%';
    document.getElementById('brightnessValue').innerText = currentBrightness + '%';
    
    // Ajustar brilho do v√≠deo (se suportado)
    if (video.style) {
      video.style.filter = `brightness(${currentBrightness}%)`;
    }
  });
  
  // Tamanho
  document.getElementById('sizeDownBtn').addEventListener('click', () => {
    currentTextSize = Math.max(30, currentTextSize - 10);
    document.getElementById('modalSize').value = currentTextSize;
    document.getElementById('modalSizeValue').innerText = currentTextSize;
  });
  
  document.getElementById('sizeUpBtn').addEventListener('click', () => {
    currentTextSize = Math.min(200, currentTextSize + 10);
    document.getElementById('modalSize').value = currentTextSize;
    document.getElementById('modalSizeValue').innerText = currentTextSize;
  });
  
  // Cor
  let colorIndex = 0;
  const colors = ['#ffaa00', '#ff0000', '#00ff00', '#0000ff', '#ffffff', '#ff00ff'];
  
  document.getElementById('colorBtn').addEventListener('click', () => {
    colorIndex = (colorIndex + 1) % colors.length;
    currentColor = colors[colorIndex];
    document.getElementById('colorBtn').style.background = currentColor;
  });
  
  // Modals
  const textModal = document.getElementById('textModal');
  const ageModal = document.getElementById('ageModal');
  
  document.getElementById('textBtn').addEventListener('click', () => {
    document.getElementById('modalText').value = currentText;
    document.getElementById('modalFont').value = currentFont;
    document.getElementById('modalSize').value = currentTextSize;
    document.getElementById('modalSizeValue').innerText = currentTextSize;
    document.getElementById('modalY').value = currentTextY;
    document.getElementById('modalYValue').innerText = currentTextY;
    textModal.classList.add('active');
  });
  
  document.getElementById('ageBtn').addEventListener('click', () => {
    document.getElementById('modalAge').value = currentAge;
    document.getElementById('modalAgeSize').value = currentAgeSize;
    document.getElementById('modalAgeSizeValue').innerText = currentAgeSize;
    document.getElementById('modalAgeY').value = currentAgeY;
    document.getElementById('modalAgeYValue').innerText = currentAgeY;
    ageModal.classList.add('active');
  });
  
  // Fechar modals
  window.closeTextModal = function() {
    textModal.classList.remove('active');
  };
  
  window.closeAgeModal = function() {
    ageModal.classList.remove('active');
  };
  
  window.applyTextModal = function() {
    currentText = document.getElementById('modalText').value;
    currentFont = document.getElementById('modalFont').value;
    currentTextSize = parseInt(document.getElementById('modalSize').value);
    currentTextY = parseInt(document.getElementById('modalY').value);
    textModal.classList.remove('active');
  };
  
  window.applyAgeModal = function() {
    currentAge = parseInt(document.getElementById('modalAge').value);
    currentAgeSize = parseInt(document.getElementById('modalAgeSize').value);
    currentAgeY = parseInt(document.getElementById('modalAgeY').value);
    ageModal.classList.remove('active');
  };
  
  // Sliders update
  document.getElementById('modalSize').addEventListener('input', (e) => {
    document.getElementById('modalSizeValue').innerText = e.target.value;
  });
  
  document.getElementById('modalY').addEventListener('input', (e) => {
    document.getElementById('modalYValue').innerText = e.target.value;
  });
  
  document.getElementById('modalAgeSize').addEventListener('input', (e) => {
    document.getElementById('modalAgeSizeValue').innerText = e.target.value;
  });
  
  document.getElementById('modalAgeY').addEventListener('input', (e) => {
    document.getElementById('modalAgeYValue').innerText = e.target.value;
  });
  
  // Bot√£o sombra
  document.getElementById('shadowBtn').addEventListener('click', toggleShadowMode);
  
  // Foto
  document.getElementById('captureBtn').addEventListener('click', () => {
    // Criar um canvas para capturar a tela inteira
    const captureCanvas = document.createElement('canvas');
    captureCanvas.width = video.videoWidth;
    captureCanvas.height = video.videoHeight;
    const captureCtx = captureCanvas.getContext('2d');
    
    // Desenhar v√≠deo
    captureCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
    
    // Desenhar overlay por cima
    const overlayCanvas = document.getElementById('drawing-canvas');
    captureCtx.drawImage(overlayCanvas, 0, 0, captureCanvas.width, captureCanvas.height);
    
    // Download
    const link = document.createElement('a');
    link.download = `torte-${new Date().getTime()}.png`;
    link.href = captureCanvas.toDataURL();
    link.click();
  });
  
  // Iniciar
  initCamera();
</script>
</body>
</html>
